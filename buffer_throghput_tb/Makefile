# common VARS and EXPORTS
## EXPORTS
export PYTHON_BIN=/usr/bin/python3
export SHELL=/bin/bash
export TOPLEVEL_LANG ?= verilog

## PATHS
GIT_ROOT=$(shell git rev-parse --show-toplevel)
SUBMOD_PATH=$(GIT_ROOT)/submodules
VERINOC_PATH=$(SUBMOD_PATH)/verinoc
CDC_PATH=$(SUBMOD_PATH)/cdc
ASYNC_SRCS_DIR=$(CDC_PATH)/src
SYNC_SRC_DIR=$(VERINOC_PATH)/srcs

## VARS
export COCOTB_HDL_TIMEUNIT      = 1ns
export COCOTB_HDL_TIMEPRECISION = 1ns
SIM ?= icarus

# VERILOG SOURCES
VERILOG_SOURCES = $(SYNC_SRC_DIR)/components/circ_fifo.v 		# SYNC
VERILOG_SOURCES += $(shell find $(ASYNC_SRCS_DIR) | grep .sv) # ASYNC
VERILOG_SOURCES += tb_top.v

TOPLEVEL := tb_top
MODULE   := test

WRITE_BURST_SIZE ?= 10
WRITE_IDLE_CYCLES_BETWEEN_BURSTS ?= 0
WRITE_NUMBER_OF_BURSTS ?= 2
READ_BURST_SIZE ?= 10
READ_IDLE_CYCLES_BETWEEN_BURSTS ?= 1
FIFO_DEPTH_W ?= 2
WRITE_FREQ ?= 1000
READ_FREQ ?=1000
MIN_FIFO_SIZE ?= 2

# PARAMS
COMPILE_ARGS  = -P $(TOPLEVEL).WRITE_BURST_SIZE=$(WRITE_BURST_SIZE)
COMPILE_ARGS += -P $(TOPLEVEL).WRITE_IDLE_CYCLES_BETWEEN_BURSTS=$(WRITE_IDLE_CYCLES_BETWEEN_BURSTS)
COMPILE_ARGS += -P $(TOPLEVEL).WRITE_NUMBER_OF_BURSTS=$(WRITE_NUMBER_OF_BURSTS)
COMPILE_ARGS += -P $(TOPLEVEL).READ_BURST_SIZE=$(READ_BURST_SIZE)
COMPILE_ARGS += -P $(TOPLEVEL).READ_IDLE_CYCLES_BETWEEN_BURSTS=$(READ_IDLE_CYCLES_BETWEEN_BURSTS)
COMPILE_ARGS += -P $(TOPLEVEL).FIFO_DEPTH_W=$(FIFO_DEPTH_W)
COMPILE_ARGS += -P $(TOPLEVEL).MIN_FIFO_SIZE=$(MIN_FIFO_SIZE)
COMPILE_ARGS += -P $(TOPLEVEL).WRITE_FREQ=$(WRITE_FREQ)
COMPILE_ARGS += -P $(TOPLEVEL).READ_FREQ=$(READ_FREQ)

all: prompt

prompt:
	@echo $(VERILOG_SOURCES)
	@echo $(VSIM_ARGS)
	@echo "COMPILE_ARGS = $(COMPILE_ARGS)"
	@echo " "
	@echo " Starting SIMULATION on $(shell date)"
	@echo " "

include $(shell cocotb-config --makefiles)/Makefile.sim